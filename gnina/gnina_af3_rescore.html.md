# AF3 rescore with gnina


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Setup

## Split the AF3 output .cif into protein.pdb and ligand.sdf

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### ChainSelect

>  ChainSelect (chain_ids)

*Select chain to save*

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L27"
target="_blank" style="float:right; font-size:smaller">source</a>

### rename_residues

>  rename_residues (structure, chain_id, new_resname='LIG')

*Rename residue name from LIG_L to LIG as LIG_L exceeds lengths and
leads to error in RDKit*

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L36"
target="_blank" style="float:right; font-size:smaller">source</a>

### split_cif

>  split_cif (cif_path, rec_chain_id, lig_chain_id, rec_pdb_path,
>                 lig_pdb_path)

*Split AF3 output CIF to protein and ligand PDBs*

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L47"
target="_blank" style="float:right; font-size:smaller">source</a>

### pdb2sdf

>  pdb2sdf (pdb_path, sdf_path)

*Convert ligand pdb to sdf file*

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L60"
target="_blank" style="float:right; font-size:smaller">source</a>

### prepare_rec_lig

>  prepare_rec_lig (cif_path, rec_chain_id, lig_chain_id, rec_pdb_path,
>                       lig_pdb_path)

*Split AF3 cif to protein.pdb (chainA) and ligand.sdf (chainL)*

``` python
# AF3 output
prepare_rec_lig('gnina_test/cif/test.cif','A','L','gnina_test/chain_A.pdb','gnina_test/chain_L.sdf')
```

``` python
# Protenix output
prepare_rec_lig('gnina_test/protenix_cif/test.cif','A','B','gnina_test/protenix_A.pdb','gnina_test/protenix_B.sdf')
```

## gnina score

According to [gnina
doc](https://github.com/gnina/gnina?tab=readme-ov-file):

``` bash
gnina -r chain_A.pdb -l chain_L.sdf --minimize -o minimized.sdf.gz
```

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L74"
target="_blank" style="float:right; font-size:smaller">source</a>

### gnina_rescore_local

>  gnina_rescore_local (protein_pdb, ligand_sdf, CNN_affinity=True,
>                           vinardo=False)

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>protein_pdb</td>
<td></td>
<td></td>
<td>receptor file</td>
</tr>
<tr>
<td>ligand_sdf</td>
<td></td>
<td></td>
<td>ligand file</td>
</tr>
<tr>
<td>CNN_affinity</td>
<td>bool</td>
<td>True</td>
<td></td>
</tr>
<tr>
<td>vinardo</td>
<td>bool</td>
<td>False</td>
<td>if True, use vinardo instead of vina</td>
</tr>
</tbody>
</table>

``` python
# %%time
# out = gnina_rescore_local('gnina_test/chain_A.pdb',
#                           'gnina_test/chain_L.sdf',
#                           CNN_affinity=False
#                           )
# out
```

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L95"
target="_blank" style="float:right; font-size:smaller">source</a>

### gnina_rescore_docker

>  gnina_rescore_docker (protein_pdb, ligand_sdf, CNN_affinity=True,
>                            vinardo=False)

*Run GNINA rescoring using Docker. Supports receptor and ligand in
different folders.*

``` python
# %%time
# out = gnina_rescore_docker('gnina_test/chain_A.pdb',
#                            'gnina_test/chain_L.sdf',
#                            CNN_affinity=False)
# out
```

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L128"
target="_blank" style="float:right; font-size:smaller">source</a>

### extract_gnina_rescore

>  extract_gnina_rescore (txt)

*Extract GNINA output metrics into a dictionary (partial match
allowed).*

``` python
out = "              _             \n             (_)            \n   __ _ _ __  _ _ __   __ _ \n  / _` | '_ \\| | '_ \\ / _` |\n | (_| | | | | | | | | (_| |\n  \\__, |_| |_|_|_| |_|\\__,_|\n   __/ |                    \n  |___/                     \n\ngnina  master:e9cb230+   Built Feb 11 2023.\ngnina is based on smina and AutoDock Vina.\nPlease cite appropriately.\n\nWARNING: No GPU detected. CNN scoring will be slow.\nRecommend running with single model (--cnn crossdock_default2018)\nor without cnn scoring (--cnn_scoring=none).\n\nCommandline: ./gnina -r chain_A.pdb -l chain_L.sdf --minimize\nAffinity: -10.96345  -1.51405 (kcal/mol)\nRMSD: 1.15404\nCNNscore: 0.49978 \nCNNaffinity: 7.32008\nCNNvariance: 0.18500\n"
```

``` python
extract_gnina_rescore(out)
```

    {'binding_energy': -10.96345,
     'uncertainty': -1.51405,
     'RMSD': 1.15404,
     'CNNscore': 0.49978,
     'CNNaffinity': 7.32008,
     'CNNvariance': 0.185}

``` python
# set CNN affinity to False
out2 = "              _             \n             (_)            \n   __ _ _ __  _ _ __   __ _ \n  / _` | '_ \\| | '_ \\ / _` |\n | (_| | | | | | | | | (_| |\n  \\__, |_| |_|_|_| |_|\\__,_|\n   __/ |                    \n  |___/                     \n\ngnina v1.1 master:e4cb380+   Built Dec 18 2023.\ngnina is based on smina and AutoDock Vina.\nPlease cite appropriately.\n\nWARNING: No GPU detected. CNN scoring will be slow.\nRecommend running with single model (--cnn crossdock_default2018)\nor without cnn scoring (--cnn_scoring=none).\n\nCommandline: ./gnina -r gnina_test/chain_A.pdb -l gnina_test/chain_L.sdf --minimize --cnn_scoring none\nAffinity: -10.96345  -1.51405 (kcal/mol)\nRMSD: 1.15404\nCNNscore: -1.00000 \nCNNaffinity: 0.00000\n"
```

``` python
extract_gnina_rescore(out2)
```

    {'binding_energy': -10.96345,
     'uncertainty': -1.51405,
     'RMSD': 1.15404,
     'CNNscore': -1.0,
     'CNNaffinity': 0.0}

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L149"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_gnina_rescore

>  get_gnina_rescore (cif_path, rec_chain_id='A', lig_chain_id='L',
>                         CNN_affinity=True, vinardo=False, is_local=True)

*Split the CIF into receptor and ligand folders, then extract the GNINA
rescored affinity score*

``` python
# get_gnina_rescore('gnina_test/cif/test.cif',
#                   rec_chain_id='A', 
#                   lig_chain_id='L',
#                   CNN_affinity=False,
#                   is_local=True)
```

``` python
# get_gnina_rescore('gnina_test/cif/test.cif',
#                   rec_chain_id='A', 
#                   lig_chain_id='L',
#                   CNN_affinity=False,
#                   vinardo=True,
#                   is_local=True)
```

Non-parallel for multiple .cif files:

``` python
# cifs = L(Path('gnina_test/cif').expanduser().glob("*.cif")) # just take cif file

# out = {p.stem: get_gnina_rescore(p) for p in tqdm(cifs)}

# out_df = pd.DataFrame(out).T
```

------------------------------------------------------------------------

<a
href="https://github.com/sky1ove/kdock/blob/main/kdock/gnina/rescore.py#L174"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_gnina_rescore_folder

>  get_gnina_rescore_folder (cif_folder, rec_chain_id='A', lig_chain_id='L',
>                                CNN_affinity=True, vinardo=False,
>                                is_local=True)

*Parallel processing to get gnina rescore given folder path*

Vinardo scoring:

``` python
# %%time
# get_gnina_rescore_folder('gnina_test/cif',
#                          rec_chain_id='A', 
#                          lig_chain_id='L',
#                          CNN_affinity=False,
#                          vinardo=True,
#                          )
```

Vina scoring:

``` python
# get_gnina_rescore_folder('gnina_test/cif',
#                          rec_chain_id='A', 
#                          lig_chain_id='L',
#                          CNN_affinity=False,
#                          vinardo=False,
#                          )
```

## End
